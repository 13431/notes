<!DOCTYPE html>
<html>
<head>
<title>Hibernate</title>
<!-- 2017-09-29 Fri 14:31 -->
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="imfine">
<meta  name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="assets/base.css">
<script src="assets/base.js"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="index.html"> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Hibernate</h1>
<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 序</a></li>
<li><a href="#sec-2">2. Session</a>
<ul>
<li><a href="#sec-2-1">2.1. get/load/query()</a></li>
<li><a href="#sec-2-2">2.2. flush/refresh()</a></li>
<li><a href="#sec-2-3">2.3. clear/evict()</a></li>
<li><a href="#sec-2-4">2.4. save/persist()</a></li>
<li><a href="#sec-2-5">2.5. update/merge()</a></li>
<li><a href="#sec-2-6">2.6. doWork</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Identifier</a></li>
<li><a href="#sec-4">4. Association</a>
<ul>
<li><a href="#sec-4-1">4.1. 1-N</a></li>
<li><a href="#sec-4-2">4.2. M-N</a></li>
<li><a href="#sec-4-3">4.3. 1-1</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Inheritance</a>
<ul>
<li><a href="#sec-5-1">5.1. SINGLE_TABLE</a></li>
<li><a href="#sec-5-2">5.2. JOINED</a></li>
<li><a href="#sec-5-3">5.3. TABLE_PER_CLASS(union)</a></li>
<li><a href="#sec-5-4">5.4. MappedSuperclass</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<section id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 序</h2>
<div class="outline-text-2" id="text-1">
<p>
创建 hibernate 工程示例：
</p>
<ol class="org-ol">
<li>创建工程，引入 jar 包
</li>
<li>创建配置文件 hibernate.cfg.xml, 配置数据库连接
</li>
<li>编写实体类(<code>entity</code>), 标明注解, 然后配置在 hibernate.cfg.xml 中
</li>
<li>创建 <code>SessionFactory</code>, 获取 <code>Session</code>, 通过操作实体类操作数据库。
</li>
</ol>
</div>
</section>
<section id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Session</h2>
<div class="outline-text-2" id="text-2">
<p>
对象的三种状态：
</p>
<ol class="org-ol">
<li><code>Transient</code>, 瞬时状态，指的是对象已经被初始化，但没有跟 hibernate 的 session 建立过联系，即数据库里没有数据对应。
</li>
<li><code>Persistent</code>, 持久化状态，指的是对象在数据中有对应数据，对象有 id 值。它可能是通过 save 或 load 等方式得到的，并且在 session 缓存中有定义。
</li>
<li><code>Detached</code>, 脱管状态，曾经被持久，在数据库中有数据对应。但是，在 session 缓存里没有记录。也许是 session 关闭了，也许是清空了。
</li>
</ol>

<p>
状态之间可以进行转换，下面是大致的转换流程：
</p>

<figure>
<p><img src="assets/image/orm-hibernate/hibernate_ostatus_2017-09-21_10-08-32.svg" alt="hibernate_ostatus_2017-09-21_10-08-32.svg">
</p>
</figure>
</div>


<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> get/load/query()</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>get/load 会优先在 session 缓存里寻找对象，如果找不到，再去查询数据库
</li>
<li>query 会直接查询数据库
</li>
<li>get 不懒，会立刻查询。如果没有找到，那么返回 null
</li>
<li>load 延迟加载，立刻返回一个代理对象。如果没有找到，那么抛出异常
</li>
<li><code>LazyInitializationException</code> !!!
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> flush/refresh()</h3>
<div class="outline-text-3" id="text-2-2">
<p>
flush 将 session 缓存里的数据同步到数据库，触发相应的 sql 语句。
</p>

<p>
以下情况，会触发 flush 操作：
</p>
<ol class="org-ol">
<li>调用 commit 的时候，会触发 session.flush() 操作。
</li>
<li>执行 session.createQuery() 查询的时候，也会触发 flush 操作。
</li>
<li>手动执行 flush 操作。
</li>
</ol>

<p>
refresh 是将数据库里的信息，同步到 session 缓存。
</p>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> clear/evict()</h3>
<div class="outline-text-3" id="text-2-3">
<p>
从 session 缓存中清理数据
</p>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> save/persist()</h3>
<div class="outline-text-3" id="text-2-4">
<p>
都是用来将瞬时对象变为持久化对象，即将数据插入数据库，对应 insert 语句。
</p>

<p>
save 是 hibernate 原生的语法，persist 是 jpa 的语法。
</p>

<p>
在执行的时候，不会立刻插入数据，只有执行了 flush 操作，才真正触发数据库操作。
</p>

<p>
save/persist 方法会立刻为实体类对象生成主键。
</p>

<p>
他们的区别是, 如果在保存之前，重新手动赋予了主键：
</p>
<ol class="org-ol">
<li>save 会忽视你的赋值
</li>
<li>persist 会抛异常
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> update/merge()</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li>他们主要用来完成实体类对象的修改，对应的是 update 语句。
</li>
<li>若更新一个持久化对象，可以不显式调用 update, 因为 flush 操作会触发 update
</li>
<li>可以将一个脱管对象转换为持久化对象
</li>
<li>merge 是 jpa 中的语法
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><span class="section-number-3">2.6</span> doWork</h3>
<div class="outline-text-3" id="text-2-6">
<p>
可以将 jdbc 的 connection 对象暴露出来，用于插入一些 jdbc 操作语法。
</p>
</div>
</div>
</section>




<section id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Identifier</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-sql"><span class="org-comment">-- JPA &#40664;&#35748;</span>
@GeneratedValue<span class="org-rainbow-delimiters-depth-1">(</span>strategy = GenerationType.AUTO/<span class="org-keyword">IDENTITY</span>/<span class="org-keyword">SEQUENCE</span>/<span class="org-keyword">TABLE</span><span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment">-- JPA &#23450;&#21046;&#24207;&#21015;/Table</span>
@GeneratedValue<span class="org-rainbow-delimiters-depth-1">(</span>generator = "xxx"<span class="org-rainbow-delimiters-depth-1">)</span>
@SequenceGenerator<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">name</span> = "xxx", sequenceName = "seq_xxx", associateSize = 1<span class="org-rainbow-delimiters-depth-1">)</span>
@TableGenerator<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">name</span> = "xxx", <span class="org-keyword">table</span> = "tb_xxx"<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment">-- Hibernate &#26684;&#24335;&#30340; generator:</span>
@GeneratedValue<span class="org-rainbow-delimiters-depth-1">(</span>generator = "yyy"<span class="org-rainbow-delimiters-depth-1">)</span>
@GenericGenerator<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">name</span> = "yyy", strategy = "native"<span class="org-rainbow-delimiters-depth-1">)</span>
@GenericGenerator<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">name</span> = "yyy", strategy = "uuid2"<span class="org-rainbow-delimiters-depth-1">)</span>
@GenericGenerator<span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">name</span> = "yyy", strategy = "<span class="org-keyword">table</span>"<span class="org-rainbow-delimiters-depth-1">)</span>
</pre>
</div>
</div>
</section>

<section id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Association</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> 1-N</h3>
<div class="outline-text-3" id="text-4-1">
<p>
一对多的关系，在数据库的角度，需要使用外键维护这种关系。
</p>

<p>
一般情况下，在多的一边的表上，建立一个外键映射到另一个表。
</p>

<p>
比如，有两个表 author, book 一般而言，book 的定义类似是这样的：
</p>
<div class="org-src-container">

<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">book</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    bookid <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    <span class="org-keyword">name</span> varchar2<span class="org-rainbow-delimiters-depth-2">(</span>20<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
    price <span class="org-type">float</span>,
    publish_date <span class="org-type">date</span> <span class="org-keyword">default</span> sysdate,

    <span class="org-comment">-- &#19979;&#38754;&#23383;&#27573;&#29992;&#26469;&#32500;&#25252;&#36319;&#20316;&#32773;&#30340;&#20851;&#31995;</span>
    <span class="org-comment">-- &#23427;&#26159;&#19968;&#20010;&#22806;&#38190;&#32422;&#26463;</span>
    authorid <span class="org-keyword">references</span> author
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
book/author 分别对应实体类 Book/Author，我们可以在其中任意一个实体类中，设置他们的关系。
</p>

<p>
如果只是在其中一个中设置关系，那么叫“单边关系”、“单向关联”，否则是“双向关联”。
</p>

<p>
其中最常用的是 <b>多对一的单向关联</b> 和 <b>多对一的双向关联</b>。
</p>

<p>
多对一的单向：
</p>
<div class="org-src-container">

<pre class="src src-java"><span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Author</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@Id</span> <span class="org-c-annotation">@GeneratedValue</span> <span class="org-keyword">private</span> <span class="org-type">long</span> <span class="org-variable-name">id</span>;
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">name</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Book</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@Id</span> <span class="org-c-annotation">@GeneratedValue</span> <span class="org-keyword">private</span> <span class="org-type">long</span> <span class="org-variable-name">id</span>;
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">name</span>;
    <span class="org-keyword">private</span> <span class="org-type">FLoat</span> <span class="org-variable-name">price</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">&#21482;&#26159;&#22312;&#22810;&#30340;&#19968;&#27573;&#35774;&#32622;&#20851;&#31995;&#12290;&#36825;&#26159;&#38750;&#24120;&#24120;&#29992;&#30340;&#19968;&#31181;&#26041;&#24335;&#12290;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#29992; @JoinColumn &#23450;&#21046;&#22806;&#38190;&#23383;&#27573;&#30340;&#21517;&#23383;</span>
    <span class="org-c-annotation">@ManyToOne</span> <span class="org-c-annotation">@JoinColumn</span>
    <span class="org-keyword">private</span> <span class="org-type">Author</span> <span class="org-variable-name">author</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
多对一的双向关系：
</p>
<div class="org-src-container">

<pre class="src src-java"><span class="org-comment-delimiter">// </span><span class="org-comment">&#22810;&#30340;&#19968;&#31471;&#65292;&#21363;&#20027;&#31471;&#65292;&#38656;&#35201;&#36127;&#36131;&#32500;&#25252;&#20851;&#31995;</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Book</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@Id</span> <span class="org-c-annotation">@GeneratedValue</span> <span class="org-keyword">private</span> <span class="org-type">long</span> <span class="org-variable-name">id</span>;
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">name</span>;
    <span class="org-keyword">private</span> <span class="org-type">FLoat</span> <span class="org-variable-name">price</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">&#21482;&#26159;&#22312;&#22810;&#30340;&#19968;&#31471;&#35774;&#32622;&#20851;&#31995;&#12290;&#36825;&#26159;&#38750;&#24120;&#24120;&#29992;&#30340;&#19968;&#31181;&#26041;&#24335;&#12290;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#29992; @JoinColumn &#23450;&#21046;&#22806;&#38190;&#23383;&#27573;&#30340;&#21517;&#23383;</span>
    <span class="org-c-annotation">@ManyToOne</span> <span class="org-c-annotation">@JoinColumn</span>
    <span class="org-keyword">private</span> <span class="org-type">Author</span> <span class="org-variable-name">author</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">&#19968;&#30340;&#19968;&#31471;&#65292;&#21363;&#20174;&#31471;&#65292;&#38656;&#35201;&#24403;&#29993;&#25163;&#25484;&#26588;</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Author</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@Id</span> <span class="org-c-annotation">@GeneratedValue</span> <span class="org-keyword">private</span> <span class="org-type">long</span> <span class="org-variable-name">id</span>;
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">name</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">&#19981;&#35201;&#35753;&#21452;&#26041;&#37117;&#21435;&#32500;&#25252;&#20851;&#31995;&#65292;&#19981;&#28982;&#20250;&#26377;&#20914;&#31361;&#25110;&#37325;&#22797;&#12290;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#19968;&#33324;&#24773;&#20917;&#19979;&#65292;&#38656;&#35201;&#35753;&#22810;&#30340;&#19968;&#31471;&#32500;&#25252;&#20851;&#31995;&#21363;&#21487;&#12290;&#36825;&#37324;&#29992; mappedBy &#34920;&#21517;&#65292;&#33258;&#24049;&#24403;&#29993;&#25163;&#25484;&#26588;&#12290;</span>
    <span class="org-c-annotation">@OneToMany</span><span class="org-rainbow-delimiters-depth-2">(</span>mappedBy = <span class="org-string">"author"</span><span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-keyword">private</span> <span class="org-type">Set</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Books</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">books</span> = <span class="org-keyword">new</span> <span class="org-type">HashSet</span><span class="org-rainbow-delimiters-depth-2">&lt;&gt;()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>在数据插入的时候，要先保存一的一端，再保存多的一端，否则，会有冗余的 SQL 语句。</b>
</p>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> M-N</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>多对多的关系，需要使用中间表维护双方关系。对应的注解为 <code>@ManyToMany</code>
</li>
<li>必须为双方制定从属关系，也就是将维护关系的责任交给其中一个实体类(<code>mappedBy</code>)，从而避免重复或冲突。
</li>
<li>可以使用 <code>@JoinTable</code> 对中间表进行定制
</li>
</ul>

<p>
例子：
</p>
<div class="org-src-container">

<pre class="src src-java"><span class="org-c-annotation">@Entity</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Emp</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@ManyToMany</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">&#36127;&#36131;&#20851;&#31995;&#30340;&#32500;&#25252;</span>
    <span class="org-c-annotation">@JoinTable</span><span class="org-rainbow-delimiters-depth-2">(</span>...<span class="org-rainbow-delimiters-depth-2">)</span>
    <span class="org-keyword">private</span> <span class="org-type">Set</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Project</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">projects</span> = <span class="org-keyword">new</span> <span class="org-type">HashSet</span><span class="org-rainbow-delimiters-depth-2">&lt;&gt;()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-c-annotation">@Entity</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Project</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@ManyToMany</span><span class="org-rainbow-delimiters-depth-2">(</span>mappedBy = <span class="org-string">"projects"</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">&#29993;&#25163;&#25484;&#26588;</span>
    <span class="org-keyword">private</span> <span class="org-type">Set</span><span class="org-rainbow-delimiters-depth-2">&lt;</span><span class="org-type">Emp</span><span class="org-rainbow-delimiters-depth-2">&gt;</span> <span class="org-variable-name">emps</span> = <span class="org-keyword">new</span> <span class="org-type">HashSet</span><span class="org-rainbow-delimiters-depth-2">&lt;&gt;()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> 1-1</h3>
<div class="outline-text-3" id="text-4-3">
<p>
两种方式：
</p>
<ol class="org-ol">
<li>在其中一个表上创建一个列，保存另一个表的主键。即外键关联。
</li>
<li>两个表，有关联的数据，使用相同的主键。即主键关联。
</li>
</ol>

<p>
<b>外键关联:</b>
</p>
<div class="org-src-container">

<pre class="src src-java"><span class="org-c-annotation">@Entity</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Person</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@Id</span> <span class="org-c-annotation">@GeneratedValue</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">&#20027;&#38190;&#33258;&#21160;&#29983;&#25104;</span>
    <span class="org-keyword">private</span> <span class="org-type">long</span> <span class="org-variable-name">id</span>;

    <span class="org-c-annotation">@OneToOne</span> <span class="org-c-annotation">@JoinColumn</span>   <span class="org-comment-delimiter">// </span><span class="org-comment">&#36127;&#36131;&#32500;&#25252;&#22806;&#38190;</span>
    <span class="org-keyword">private</span> <span class="org-type">IdCard</span> <span class="org-variable-name">idcard</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-c-annotation">@Entity</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">IdCard</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@Id</span> <span class="org-c-annotation">@GeneratedValue</span> <span class="org-comment-delimiter">// </span><span class="org-comment">&#20027;&#38190;&#33258;&#21160;&#29983;&#25104;</span>
    <span class="org-keyword">private</span> <span class="org-type">long</span> <span class="org-variable-name">id</span>;

    <span class="org-c-annotation">@OneToOne</span><span class="org-rainbow-delimiters-depth-2">(</span>mappedBy=<span class="org-string">"idcard"</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">&#29993;&#25163;&#25484;&#26588;</span>
    <span class="org-keyword">private</span> <span class="org-type">Person</span> <span class="org-variable-name">person</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
<b>主键关联:</b>
</p>
<div class="org-src-container">

<pre class="src src-java"><span class="org-c-annotation">@Entity</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Person</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@Id</span>       <span class="org-comment-delimiter">// </span><span class="org-comment">&#20027;&#38190;*&#19981;&#35201;*&#33258;&#21160;&#29983;&#25104;!!</span>
    <span class="org-keyword">private</span> <span class="org-type">long</span> <span class="org-variable-name">id</span>;

    <span class="org-c-annotation">@OneToOne</span> <span class="org-comment-delimiter">// </span><span class="org-comment">&#36127;&#36131;&#32500;&#25252;&#22806;&#38190;&#65292;&#23558;&#22806;&#38190;&#26144;&#23556;&#21040;&#20027;&#38190;&#12290;&#21363;&#23558;&#21478;&#19968;&#24352;&#34920;&#30340;&#22806;&#38190;&#26144;&#23556;&#21040;&#26412;&#34920;&#30340;&#20027;&#38190;&#12290;</span>
    <span class="org-c-annotation">@MapsId</span> <span class="org-c-annotation">@JoinColumn</span><span class="org-rainbow-delimiters-depth-2">(</span>name = <span class="org-string">"id"</span><span class="org-rainbow-delimiters-depth-2">)</span> 
    <span class="org-keyword">private</span> <span class="org-type">IdCard</span> <span class="org-variable-name">idcard</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-c-annotation">@Entity</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">IdCard</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@Id</span> <span class="org-c-annotation">@GeneratedValue</span> <span class="org-comment-delimiter">// </span><span class="org-comment">&#20027;&#38190;&#33258;&#21160;&#29983;&#25104;</span>
    <span class="org-keyword">private</span> <span class="org-type">long</span> <span class="org-variable-name">id</span>;

    <span class="org-c-annotation">@OneToOne</span><span class="org-rainbow-delimiters-depth-2">(</span>mappedBy=<span class="org-string">"idcard"</span><span class="org-rainbow-delimiters-depth-2">)</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">&#29993;&#25163;&#25484;&#26588;</span>
    <span class="org-keyword">private</span> <span class="org-type">Person</span> <span class="org-variable-name">person</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Inheritance</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> SINGLE_TABLE</h3>
<div class="outline-text-3" id="text-5-1">
<p>
将所有的东西塞进 <b>一张表</b> 中，即所有的子类跟父类使用一张表，
在这张表中使用“区别列”(DiscriminatorColumn)来区分各个类。
</p>

<p>
这是默认的继承策略。
</p>
<div class="org-src-container">

<pre class="src src-java"><span class="org-c-annotation">@Entity</span>
<span class="org-c-annotation">@Inheritance</span><span class="org-rainbow-delimiters-depth-1">(</span>strategy = <span class="org-constant">InheritanceType</span>.SINGLE_TABLE<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-c-annotation">@DiscriminatorColumn</span><span class="org-rainbow-delimiters-depth-1">(</span>name = <span class="org-string">"xxx"</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment-delimiter">// </span><span class="org-comment">&#21487;&#20197;&#23450;&#21046;&#20998;&#21106;&#21015;&#30340;&#21517;&#23383;</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Animal</span> <span class="org-rainbow-delimiters-depth-1">{}</span>

<span class="org-c-annotation">@Entity</span>
<span class="org-c-annotation">@DiscriminatorValue</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">"&#29399;"</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-comment-delimiter">// </span><span class="org-comment">&#21487;&#20197;&#23450;&#21046;</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> Dog <span class="org-type">extend</span> <span class="org-type">Animal</span> <span class="org-rainbow-delimiters-depth-1">{}</span>
</pre>
</div>

<p>
它并不符合范式，但也有自己的优点：
</p>
<ul class="org-ul">
<li>使用了区别的列
</li>
<li>只使用了一张表，所以查询速度快
</li>
<li>缺点：子类的独有列，不能添加唯一/非空约束
</li>
<li>缺点：太多冗余字段
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> JOINED</h3>
<div class="outline-text-3" id="text-5-2">
<p>
是一种完全“符合范式”的设计：
</p>
<ul class="org-ul">
<li>将所有共有的属性提取到父表中
</li>
<li>仅将子类特有的属性保存到子表中
</li>
<li>父表跟子表通过外键的方式建立关系
</li>
<li>如果查询子表的详细数据，通过关联查询关联相关表即可
</li>
</ul>

<div class="org-src-container">

<pre class="src src-java"><span class="org-c-annotation">@Entity</span>
<span class="org-c-annotation">@Inheritance</span><span class="org-rainbow-delimiters-depth-1">(</span>strategy = <span class="org-constant">InheritanceType</span>.JOINED<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Animal</span> <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-c-annotation">@PrimaryKeyJoinColumn</span><span class="org-rainbow-delimiters-depth-1">(</span>name = <span class="org-string">"xxxxid"</span><span class="org-rainbow-delimiters-depth-1">)</span>  <span class="org-comment-delimiter">// </span><span class="org-comment">&#21487;&#20197;&#23450;&#21046;&#20851;&#32852;&#20027;&#38190;</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> Dog <span class="org-type">extend</span> <span class="org-type">Animal</span> <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
总结：
</p>
<ul class="org-ul">
<li>优点：没有任何冗余
</li>
<li>缺点：查询的效率低，因为需要关联各张表
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> TABLE_PER_CLASS(union)</h3>
<div class="outline-text-3" id="text-5-3">
<p>
每个类对应一张表，大家互相隔离，各自为政!
</p>

<div class="org-src-container">

<pre class="src src-java"><span class="org-c-annotation">@Entity</span>
<span class="org-c-annotation">@Inheritance</span><span class="org-rainbow-delimiters-depth-1">(</span>strategy = <span class="org-constant">InheritanceType</span>.TABLE_PER_CLASS<span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Animal</span> <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-c-annotation">@Entity</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> Dog <span class="org-type">extend</span> <span class="org-type">Animal</span> <span class="org-rainbow-delimiters-depth-1">{</span> <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>

<p>
总结：
</p>
<ul class="org-ul">
<li>优点：独立，自由，查询快
</li>
<li>如果只查询子类，那么不需要任何关联；但如果查询父类的话，需要使用 Union 关联各表
</li>
<li>缺点：存在冗余字段
</li>
<li>缺点：如果要更新父类中的字段，每个子表都需要去更新
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> MappedSuperclass</h3>
<div class="outline-text-3" id="text-5-4">
<p>
如果父类不是 Entity，只是为子类提供公共属性，那么，将其注解为 <code>@MappedSuperclass</code> 即可。
</p>

<div class="org-src-container">

<pre class="src src-java"><span class="org-c-annotation">@MappedSuperclass</span>
<span class="org-keyword">abstract</span> <span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Person</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-c-annotation">@Id</span> <span class="org-keyword">private</span> <span class="org-type">long</span> <span class="org-variable-name">id</span>;
    <span class="org-c-annotation">@Column</span> <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">name</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-c-annotation">@Entity</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> Girl <span class="org-type">extend</span> <span class="org-type">Person</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">wechat</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-c-annotation">@Entity</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> Boy <span class="org-type">extend</span> <span class="org-type">Person</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">address</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
<p class="author">Author: imfine</p>
<p class="date">Created: 2017-09-29 Fri 14:31</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.2.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation">Go ahead, never stop.</p>
</div>
</body>
</html>
