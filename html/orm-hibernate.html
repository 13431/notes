<!DOCTYPE html>
<html>
<head>
<title>Hibernate</title>
<!-- 2017-09-22 Fri 10:49 -->
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="imfine">
<meta  name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="assets/base.css">
<script src="assets/base.js"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="index.html"> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Hibernate</h1>
<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 序</a></li>
<li><a href="#sec-2">2. Session</a>
<ul>
<li><a href="#sec-2-1">2.1. get/load/query()</a></li>
<li><a href="#sec-2-2">2.2. flush/refresh()</a></li>
<li><a href="#sec-2-3">2.3. clear/evict()</a></li>
<li><a href="#sec-2-4">2.4. save/persist()</a></li>
<li><a href="#sec-2-5">2.5. update/merge()</a></li>
<li><a href="#sec-2-6">2.6. doWork</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<section id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 序</h2>
<div class="outline-text-2" id="text-1">
<p>
创建 hibernate 工程示例：
</p>
<ol class="org-ol">
<li>创建工程，引入 jar 包
</li>
<li>创建配置文件 hibernate.cfg.xml, 配置数据库连接
</li>
<li>编写实体类(<code>entity</code>), 标明注解, 然后配置在 hibernate.cfg.xml 中
</li>
<li>创建 <code>SessionFactory</code>, 获取 <code>Session</code>, 通过操作实体类操作数据库。
</li>
</ol>
</div>
</section>
<section id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Session</h2>
<div class="outline-text-2" id="text-2">
<p>
对象的三种状态：
</p>
<ol class="org-ol">
<li><code>Transient</code>, 瞬时状态，指的是对象已经被初始化，但没有跟 hibernate 的 session 建立过联系，即数据库里没有数据对应。
</li>
<li><code>Persistent</code>, 持久化状态，指的是对象在数据中有对应数据，对象有 id 值。它可能是通过 save 或 load 等方式得到的，并且在 session 缓存中有定义。
</li>
<li><code>Detached</code>, 脱管状态，曾经被持久，在数据库中有数据对应。但是，在 session 缓存里没有记录。也许是 session 关闭了，也许是清空了。
</li>
</ol>

<p>
状态之间可以进行转换，下面是大致的转换流程：
</p>

<figure>
<p><img src="assets/image/orm-hibernate/hibernate_ostatus_2017-09-21_10-08-32.svg" alt="hibernate_ostatus_2017-09-21_10-08-32.svg">
</p>
</figure>
</div>


<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> get/load/query()</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>get/load 会优先在 session 缓存里寻找对象，如果找不到，再去查询数据库
</li>
<li>query 会直接查询数据库
</li>
<li>get 不懒，会立刻查询。如果没有找到，那么返回 null
</li>
<li>load 延迟加载，立刻返回一个代理对象。如果没有找到，那么抛出异常
</li>
<li><code>LazyInitializationException</code> !!!
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> flush/refresh()</h3>
<div class="outline-text-3" id="text-2-2">
<p>
flush 将 session 缓存里的数据同步到数据库，触发相应的 sql 语句。
</p>

<p>
以下情况，会触发 flush 操作：
</p>
<ol class="org-ol">
<li>调用 commit 的时候，会触发 session.flush() 操作。
</li>
<li>执行 session.createQuery() 查询的时候，也会触发 flush 操作。
</li>
<li>手动执行 flush 操作。
</li>
</ol>

<p>
refresh 是将数据库里的信息，同步到 session 缓存。
</p>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> clear/evict()</h3>
<div class="outline-text-3" id="text-2-3">
<p>
从 session 缓存中清理数据
</p>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="section-number-3">2.4</span> save/persist()</h3>
<div class="outline-text-3" id="text-2-4">
<p>
都是用来将瞬时对象变为持久化对象，即将数据插入数据库，对应 insert 语句。
</p>

<p>
save 是 hibernate 原生的语法，persist 是 jpa 的语法。
</p>

<p>
在执行的时候，不会立刻插入数据，只有执行了 flush 操作，才真正触发数据库操作。
</p>

<p>
save/persist 方法会立刻为实体类对象生成主键。
</p>

<p>
他们的区别是, 如果在保存之前，重新手动赋予了主键：
</p>
<ol class="org-ol">
<li>save 会忽视你的赋值
</li>
<li>persist 会抛异常
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="section-number-3">2.5</span> update/merge()</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li>他们主要用来完成实体类对象的修改，对应的是 update 语句。
</li>
<li>若更新一个持久化对象，可以不显式调用 update, 因为 flush 操作会触发 update
</li>
<li>可以将一个脱管对象转换为持久化对象
</li>
<li>merge 是 jpa 中的语法
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><span class="section-number-3">2.6</span> doWork</h3>
<div class="outline-text-3" id="text-2-6">
<p>
可以将 jdbc 的 connection 对象暴露出来，用于插入一些 jdbc 操作语法。
</p>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
<p class="author">Author: imfine</p>
<p class="date">Created: 2017-09-22 Fri 10:49</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.2.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation">Go ahead, never stop.</p>
</div>
</body>
</html>
