<!DOCTYPE html>
<html>
<head>
<title>Oracle 数据库</title>
<!-- 2017-08-20 Sun 16:03 -->
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="imfine">
<meta  name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="assets/base.css">
<script src="assets/base.js"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="index.html"> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Oracle 数据库</h1>
<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 序</a></li>
<li><a href="#sec-2">2. 甜点</a>
<ul>
<li><a href="#sec-2-1">2.1. 示例</a></li>
<li><a href="#sec-2-2">2.2. 题库</a></li>
</ul>
</li>
<li><a href="#sec-3">3. 体系结构</a>
<ul>
<li><a href="#sec-3-1">3.1. Client</a>
<ul>
<li><a href="#sec-3-1-1">3.1.1. Sqlplus</a></li>
<li><a href="#sec-3-1-2">3.1.2. JDBC</a></li>
</ul>
</li>
<li><a href="#sec-3-2">3.2. TNSListener</a></li>
<li><a href="#sec-3-3">3.3. Server</a>
<ul>
<li><a href="#sec-3-3-1">3.3.1. 实例(Instance)</a></li>
<li><a href="#sec-3-3-2">3.3.2. 数据库(Database)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-4">4. 用户权限</a></li>
<li><a href="#sec-5">5. SQL 语句</a></li>
<li><a href="#sec-6">6. Objects</a></li>
<li><a href="#sec-7">7. PL/SQL编程</a></li>
<li><a href="#sec-8">8. 锁/事务</a></li>
<li><a href="#sec-9">9. hint/explain</a></li>
<li><a href="#sec-10">10. Miscellaneous</a>
<ul>
<li><a href="#sec-10-1">10.1. 操作系统历史 (Operate System History)</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
数据库本质是用计算机存储数据的一种系统。
它是位于 <code>用户</code> 和 <code>系统</code> 之间的一种管理软件。
</p>

<section id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 序</h2>
<div class="outline-text-2" id="text-1">
<ol class="org-ol">
<li>登录 SQLPLUS
<pre class="example">
cmd
sqlplus [用户名]/[密码][@数据库] [参数]
sqlplus sys/orcl as sysdba  -- 登录 sys 用户，必须指定 sysdba 或 sysoper 身份
sqlplus system/orcl         -- 数据库管理员
</pre>
</li>

<li>创建一个自己的用户(比如 vip/vip)
<div class="org-src-container">

<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-builtin">user</span> vip identified <span class="org-keyword">by</span> vip;     <span class="org-comment">-- &#27880;&#24847;&#65292;&#26032;&#21019;&#24314;&#30340;&#29992;&#25143;&#65292;&#20160;&#20040;&#26435;&#38480;&#37117;&#27809;&#26377;&#65292;&#38656;&#35201;&#25480;&#26435;&#21518;&#25165;&#33021;&#20351;&#29992;</span>
<span class="org-keyword">grant</span> <span class="org-keyword">create</span> <span class="org-keyword">session</span> <span class="org-keyword">to</span> vip;           <span class="org-comment">-- &#25480;&#20104;&#30331;&#24405;&#30340;&#26435;&#38480;</span>
<span class="org-keyword">grant</span> <span class="org-keyword">connect</span> <span class="org-keyword">to</span> vip;                  <span class="org-comment">-- &#35282;&#33394;&#26159;&#24456;&#22810;&#26435;&#38480;&#30340;&#25171;&#21253;&#65292;connect &#26159;&#19968;&#31181;&#35282;&#33394;&#65292;&#23427;&#21253;&#21547;&#20102;&#36830;&#25509;&#26597;&#30475;&#25968;&#25454;&#30340;&#19968;&#20123;&#22522;&#26412;&#26435;&#38480;</span>
<span class="org-keyword">grant</span> dba <span class="org-keyword">to</span> vip;                      <span class="org-comment">-- dba &#26159;&#32477;&#22823;&#22810;&#25968;&#26435;&#38480;&#30340;&#38598;&#21512;&#65292;&#23427;&#22522;&#26412;&#33021;&#20570;&#25152;&#26377;&#20107;&#24773;&#65292;&#25152;&#20197;&#24456;&#23569;&#21333;&#29420;&#25480;&#20104;&#29992;&#25143;&#12290;&#20294;&#22312;&#27979;&#35797;&#29615;&#22659;&#20013;&#65292;&#36825;&#26679;&#65292;&#24456;&#29245;&#12290;</span>

<span class="org-comment">-- &#19978;&#38754;&#30340;&#21019;&#24314;&#29992;&#25143;&#12289;&#25480;&#20104;&#26435;&#38480;&#20004;&#27493;&#25805;&#20316;&#65292;&#21487;&#20197;&#31616;&#21270;&#20026;&#19979;&#38754;&#19968;&#27493;&#65306;</span>
<span class="org-keyword">grant</span> dba <span class="org-keyword">to</span> vip identified <span class="org-keyword">by</span> vip;    <span class="org-comment">-- &#27880;&#24847;&#65292;&#20351;&#29992;&#20998;&#21495;&#32467;&#23614;</span>
</pre>
</div>
</li>

<li>切换到用户
<pre class="example">
sqlplus vip/vip  -- 在 cmd 下
conn vip/vip     -- 在 sqlplus 中
</pre>
</li>

<li>使用
<pre class="example">
create table aaa (id int);
</pre>
</li>

<li>激活内置的测试账号，这里面有几张示例表，可以用它们练习下查询
<pre class="example">
alter user scott account unlock;
conn scott/tiger
</pre>
</li>

<li>修改密码
<pre class="example">
alter user scott identified by [newpassword];
</pre>
</li>
</ol>
</div>
</section>

<section id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> 甜点</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> 示例</h3>
<div class="outline-text-3" id="text-2-1">
<p>
[题目] 从 scott 用户的 emp/dept 表中，找到 “来自芝加哥最有钱的那个人” 。
</p>

<p>
首先，我们需要理清思路。
</p>

<p>
这里总共有两个条件：
</p>
<ol class="org-ol">
<li>这个人来自芝加哥
</li>
<li>这个人是最有钱的，而且是芝加哥最有钱的
</li>
</ol>

<p>
我们可以看出，第二个条件是依赖第一个条件的。
</p>

<p>
所以，分两步查询：
</p>
<ol class="org-ol">
<li>找出所有来自芝加哥的人
</li>
<li>从这些人中，找到最有钱的那个。这一步，可以通过 max 函数或者 order by 方式实现。
</li>
</ol>

<p>
<b>下面是语句示例：</b>
</p>
<div class="org-src-container">

<pre class="src src-sql"><span class="org-comment">---- &#31532;&#19968;&#27493;&#65306;&#25214;&#21040;&#26469;&#33258;&#33437;&#21152;&#21733;&#30340;&#25152;&#26377;&#20154;&#12290;&#19979;&#38754;&#20004;&#31181;&#20889;&#27861;&#31561;&#20215;&#65306;</span>

<span class="org-keyword">select</span> e.* <span class="org-keyword">from</span> emp e
  <span class="org-keyword">join</span> dept d <span class="org-keyword">on</span> <span class="org-rainbow-delimiters-depth-1">(</span>e.deptno=d.deptno<span class="org-rainbow-delimiters-depth-1">)</span>
  <span class="org-keyword">where</span> d.loc=<span class="org-string">'CHICAGO'</span>;

<span class="org-keyword">select</span> e.* <span class="org-keyword">from</span> emp e, dept d
  <span class="org-keyword">where</span> d.deptno = e.deptno
        <span class="org-keyword">and</span> d.loc=<span class="org-string">'CHICAGO'</span>;


<span class="org-comment">---- &#31532;&#20108;&#27493;&#65292;&#22522;&#20110;&#19978;&#38754;&#32467;&#26524;&#65292;&#31579;&#36873;&#20986;&#26368;&#26377;&#38065;&#30340;&#37027;&#20010;</span>

<span class="org-comment">-- &#21487;&#20197;&#36890;&#36807; max &#20989;&#25968;</span>
<span class="org-keyword">select</span> e.* <span class="org-keyword">from</span> emp e, dept d
  <span class="org-keyword">where</span> e.deptno = d.deptno
        <span class="org-keyword">and</span> d.loc=<span class="org-string">'CHICAGO'</span>
        <span class="org-keyword">and</span> sal = 
            <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">select</span> <span class="org-builtin">max</span><span class="org-rainbow-delimiters-depth-2">(</span>sal<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-keyword">from</span> emp e, dept d
              <span class="org-keyword">where</span> e.deptno = d.deptno
                    <span class="org-keyword">and</span> d.loc=<span class="org-string">'CHICAGO'</span><span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-comment">-- &#21487;&#20197;&#36890;&#36807; order by &#26041;&#24335;</span>
<span class="org-keyword">select</span> ename <span class="org-keyword">from</span>
  <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-keyword">select</span> e.*, d.* <span class="org-keyword">from</span> emp e, dept d
    <span class="org-keyword">where</span> e.deptno = d.deptno
          <span class="org-keyword">and</span> d.loc=<span class="org-string">'CHICAGO'</span>
    <span class="org-keyword">order</span> <span class="org-keyword">by</span> sal <span class="org-keyword">desc</span><span class="org-rainbow-delimiters-depth-1">)</span>
<span class="org-keyword">where</span> rownum = 1;
</pre>
</div>

<p>
注意，实现的方式，不止上面的那些。但总体 <b>思路</b> 是一样的。
</p>

<p>
所以，思路永远是最重要的。
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> 题库</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>在芝加哥工作的人中，谁的工资最高
</li>
<li>查询每个部门下有多少员工
</li>
<li>查询除去 salesman 所有平均工资超过 1500 的部门
</li>
<li>查询在 new york 工作的所有员工的姓名，部门名称和工资信息
</li>
<li>查询姓名为 King 的员工的编号，名称跟部门
</li>
<li>查询各种工作的最低工资
</li>
<li>查询工龄大于10年的所有员工信息
</li>
<li>查询每个部门员工数量，平均工资和平均工作年限
</li>
<li>统计各部门每个工种的人数，平均工资。
</li>
<li>查询从事同一种工作但不属于同一部门的员工信息。
</li>
<li>查询所有员工工资都大于1000的部门的信息及员工信息
</li>
<li>查询入职日期早于其直接上级的所有员工信息。
</li>
<li>列出雇员中（除去mgr为空的人)工资第二高的人。
</li>
<li>列出1981年来公司所有员工的总收入（包括sal和comm）
</li>
</ul>
</div>
</div>
</section>

<section id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> 体系结构</h2>
<div class="outline-text-2" id="text-3">
<p>
Oracle 采取的是 Client/Server 架构。
</p>


<figure>
<p><img src="assets/dot/oracle_cs.gif" alt="oracle_cs.gif">
</p>
</figure>


<p>
客户端(<code>Client</code>)操作数据库的请求发送后，服务端的监听器(<code>TNSListener</code>)接收到请求，并将其转发给相应的数据库实例(<code>Instance</code>)，再由实例(<code>Instance</code>)去操纵数据库(<code>Database</code>)。
返回操作结果，是一个相反的过程。下面是个简陋的图示:
</p>


<figure>
<p><img src="assets/dot/oracle_construct.gif" alt="oracle_construct.gif">
</p>
</figure>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Client</h3>
<div class="outline-text-3" id="text-3-1">
</div><div id="outline-container-sec-3-1-1" class="outline-4">
<h4 id="sec-3-1-1"><span class="section-number-4">3.1.1</span> Sqlplus</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
这是一个轻量级的功能强大的客户端, 是 dba 必须掌握的工具。
</p>

<p>
用 <code>sqlplus</code> 连接数据库的语法为：
</p>
<div class="org-src-container">

<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">Usage:</span>
<span class="org-comment-delimiter">#   </span><span class="org-comment">sqlplus &#29992;&#25143;&#21517;/&#23494;&#30721;@&#20027;&#26426;&#21517;:&#31471;&#21475;&#21495;/&#23454;&#20363;&#21517;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#21442;&#25968;&#20010;&#25968;&#19981;&#26159;&#22266;&#23450;&#30340;</span>

sqlplus                         <span class="org-comment-delimiter"># </span><span class="org-comment">&#20250;&#35201;&#27714;&#20320;&#36755;&#20837;&#29992;&#25143;&#21517;&#23494;&#30721;&#65292;&#40664;&#35748;&#36830;&#25509;&#26412;&#22320; ORACLE_SID &#21464;&#37327;&#25351;&#23450;&#30340;&#25968;&#25454;&#24211;</span>
sqlplus vip                     <span class="org-comment-delimiter"># </span><span class="org-comment">&#20250;&#35201;&#27714;&#20320;&#36755;&#20837;&#23494;&#30721;</span>
sqlplus vip/vip                 <span class="org-comment-delimiter"># </span><span class="org-comment">&#36830;&#25509;&#26412;&#22320; ORACLE_SID &#21464;&#37327;&#25351;&#23450;&#30340;&#25968;&#25454;&#24211;</span>

sqlplus sys/hello as sysdba     <span class="org-comment-delimiter"># </span><span class="org-comment">sys &#29992;&#25143;&#24517;&#39035;&#29992; sysdba &#25110; sysoper &#30340;&#36523;&#20221;&#30331;&#24405;</span>

sqlplus vip@192.168.0.111/orcl  <span class="org-comment-delimiter"># </span><span class="org-comment">&#36830;&#25509; 192.168.0.111 &#26426;&#22120;&#19978;&#30340; orcl &#25968;&#25454;&#24211;&#65292;&#29992;&#25143;&#21517;&#20026; vip</span>
sqlplus vip@192db               <span class="org-comment-delimiter"># </span><span class="org-comment">&#36830;&#25509; &#21035;&#21517; &#20026; 192db &#30340;&#25968;&#25454;&#24211;</span>
</pre>
</div>


<p>
我们可以配置 sqlplus 的一些行为，两个命令：
</p>
<ol class="org-ol">
<li>show. 用来显示配置参数
</li>
<li>set.  用来设置配置参数
</li>
</ol>

<p>
比如：
</p>
<pre class="example">
show all               -- 显示所有配置参数
show lines             -- 显示 lines 的配置信息
show errors            -- 显示错误
set lines[ize] 333     -- 将行宽设置为 333
set pages[ize] 444     -- 将每页的记录数设置为 444
set echo off/on        -- 导入外部文件，是否要显示原始 sql 语句
set feedback on/off    -- 是否显示“查询到xx数据”等信息
set timing on/off      -- 是否显示语句的执行时间
set autocommit on/off  -- 是否启用自动提交
set autotrace on/off   -- 是否输出执行计划
set serveroutput on/off-- 是否显示来自服务端的信息
column aaa format a22  -- 将列 'aaa' 的宽度限制为 22 个字幕'a'的大小。column 命令很强大，语句也复杂，此处不提。
</pre>

<p>
在 sqlplus 中有缓冲区的概念:
</p>
<pre class="example">
缓冲区是用来记录上一次执行的命令语句的空间。
</pre>

<p>
我们可以通过一些列简单命令，对上一次输入的语句进行一些控制:
</p>
<ul class="org-ul">
<li>增 <code>append/insert</code>
</li>
<li>删 <code>delete</code>
</li>
<li>改 <code>change</code>
</li>
<li>查 <code>list</code>
</li>
<li>执行修改后的语句 <code>run</code> 或者 <code>/</code>
</li>
</ul>

<p>
例子：
</p>
<pre class="example">
list         -- 显示完整的缓存区
list 3       -- 显示并定位到第三行
list 3 5     -- 显示第三行到第五行的内容
list last    -- 定位到最后一行
</pre>

<pre class="example">
list 3
del               -- 删除第三行
</pre>

<pre class="example">
list 3
append  order by sal  -- 定位到第三行，然后追加 order by sal
insert order by sal   -- 开启新的一行，插入 order by sal
</pre>

<pre class="example">
list 3
change /emp/dept      -- 定位到第三行，将这一行的 emp 换为 dept
</pre>

<p>
还有其他一些命令：
</p>
<pre class="example">
get D:\aaa.sql        -- 将文件加载到缓冲区，但不执行
start D:\aaa.sql      -- 将文件加载到缓冲区，并且执行
@D:\aaa.sql           -- 是上面一条语句的简写形式
save D:\bbb.sql       -- 将缓冲区的内容保存到文件中
edit                  -- 调用外部编辑器，编辑缓冲区
clear screen          -- 清空缓冲区
</pre>

<pre class="example">
show user             -- 显示当前用户
show parameters       -- 显示 oracle 的配置参数
show parameters nls   -- 显示 oracle 中所有跟语言配置相关的一些参数
describe emp          -- 显示 emp 表的结构信息
</pre>
</div>
</div>

<div id="outline-container-sec-3-1-2" class="outline-4">
<h4 id="sec-3-1-2"><span class="section-number-4">3.1.2</span> JDBC</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
用 Java 连接数据库，需要用到 jdbc 驱动，它们可以在下面目录中找到：
</p>
<pre class="example">
主目录\product\12.1.0\dbhome_1\jdbc\lib\*.jar
</pre>

<p>
比如 <code>ojdbc7_g.jar</code>, <code>7</code> 表示适用于 JDK 版本 1.7, <code>g</code> 表示自带更多调试信息。
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> TNSListener</h3>
<div class="outline-text-3" id="text-3-2">
<p>
TNSListener，是用来监听来自客户端的请求，并将其转发给相对应的服务端实例的一种后台服务。
</p>

<p>
它是沟通客户端与服务端的一个桥梁。
</p>

<p>
比如，下面用 <code>sqlplus</code> 客户端将会连接 <code>localhost</code> 上的 <code>orcl</code> 数据库:
</p>
<pre class="example">
sqlplus vip/vip@localhost/orcl
</pre>

<p>
请求会发送到 localhost 主机的 1521 号端口，
作为监听的 TNSListener 收到这个请求后，再把请求转发给对应的 orcl 数据库实例。
</p>

<p>
所以必须开启监听服务，并且配置正确，才能连接操作数据库。
</p>
<pre class="example">
注：如果用 sqlplus vip/vip 的方式连接数据库，即没有指定连接的机器，那么默认连接的是本机数据库
这种连接是不需要监听服务的，因为为了增加连接速度，这样的本地连接 oracle 会使用一个专用的进程直接连接实例
</pre>

<p>
我们可以使用 Oracle 提供的 <code>lsnrctl</code> 命令操纵监听服务的开启或关闭：
</p>
<pre class="example">
lsnrctl status    # 查看状态
lsnrctl stop      # 停止监听服务
lsnrctl start     # 开启监听服务
lsnrctl reload    # 重启监听服务
lsnrctl services  # 查看监听的连接情况
</pre>

<p>
我们可以使用 Oracle 的 Net Manager 工具来配置自己的监听器。
</p>

<p>
实质上，用 Net Manager 配置跟直接修改下面文件的作用是一样的：
</p>
<pre class="example">
主目录\product\12.1.0\dbhome_1\network\admin\listener.ora
</pre>

<p>
我们在 Net Manager 中对 listener 的配置对应的是这一段代码：
</p>
<pre class="example">
LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 0.0.0.0)(PORT = 1521))
    )
    ...
  )
</pre>

<p>
只要修改其中的 host/port 等，重启监听服务即可。
</p>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Server</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Oracle 服务端分为两部分：
</p>
<ol class="org-ol">
<li><code>Instance</code> 实例
</li>
<li><code>Database</code> 数据库
</li>
</ol>
</div>

<div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> 实例(Instance)</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
<b>实例</b>, 又称为数据库引擎，由 <code>SGA(System Global Area, 系统全局区)</code> 和 <code>一系列后台进程</code> 组成。
它需要启动才会生成，用来加载并管理一个数据库。
</p>

<p>
<b>服务启动的大致过程：</b>
</p>
<ol class="org-ol">
<li>[读取] 读取系统的 ORACLE_SID 环境变量，确定要启动的实例名字，比如为 xxoo
</li>
<li>[加载] 从 <code>$ORABASE/admin/xxoo</code> 和 <code>$ORA_HOME/database/SPFILEXXOO.ora</code> 等位置加载相关配置文件。配置文件的名字是根据 sid 来定义的。
</li>
<li>[启动] 从配置文件中，读取相关信息，比如数据库名字、数据库控制文件位置、SGA 等信息，并根据这些，初始化数据库加载需要的 <code>内存空间(SGA)</code> 和 <code>相关进程</code> 。
</li>
<li>[装载] 根据配置文件中读取的数据库信息，找到各种数据文件位置，并装载数据库。
</li>
<li>[启动] 进行数据校验等，如果没有问题，启动数据库。
</li>
</ol>

<p>
可以通过查看启动过程协助理解：
</p>
<div class="org-src-container">

<pre class="src src-sql"><span class="org-comment">-- &#39318;&#20808;&#65292;&#30331;&#24405; sys &#29992;&#25143;&#65292;&#21482;&#26377;&#31649;&#29702;&#21592;&#25165;&#26377;&#23436;&#20840;&#25805;&#32437;&#25968;&#25454;&#24211;&#30340;&#26435;&#21147;</span>
<span class="org-comment">-- shutdown &#29992;&#26469;&#20851;&#38381;&#12290;&#22914;&#26524;&#19981;&#24102;&#21442;&#25968;&#65292;&#40664;&#35748;&#20026; normal</span>
<span class="org-comment">---- immediate &#34920;&#31034;&#31435;&#21363;&#20851;&#38381;&#65292;&#22914;&#26524;&#26377;&#26410;&#22788;&#29702;&#23436;&#25805;&#20316;&#65292;&#22238;&#28378;&#24182;&#26029;&#24320;</span>
<span class="org-comment">---- normal &#34920;&#31034;&#31561;&#24453;&#25152;&#26377;&#36830;&#25509;&#26029;&#24320;&#25165;&#20851;&#38381;&#25968;&#25454;&#24211;</span>
<span class="org-comment">---- &#20854;&#20182;&#21442;&#25968;&#65292;&#30053;</span>
shutdown <span class="org-keyword">immediate</span>;

<span class="org-comment">-- &#21551;&#21160;&#25968;&#25454;&#24211;&#65292;&#20998;&#35299;&#20026;&#19977;&#20010;&#21160;&#20316;&#65306;</span>
<span class="org-comment">---- &#21551;&#21160;&#23454;&#20363;</span>
<span class="org-comment">---- &#21033;&#29992;&#21551;&#21160;&#30340;&#23454;&#20363;&#21435;&#25346;&#36733;&#25968;&#25454;&#24211;</span>
<span class="org-comment">---- &#26657;&#39564;&#24182;&#25171;&#24320;&#25968;&#25454;&#24211;</span>
<span class="org-comment">-- &#21482;&#26377;&#23436;&#20840;&#25171;&#24320;&#65292;&#25165;&#33021;&#36827;&#34892;&#23436;&#20840;&#30340;&#25968;&#25454;&#25805;&#20316;</span>
<span class="org-comment">-- &#20063;&#21487;&#20197;&#25351;&#23450;&#21442;&#25968;&#65292;&#21551;&#21160;&#21040;&#26576;&#20010;&#38454;&#27573;&#12290;&#36825;&#26159;&#22312;&#32500;&#25252;&#25968;&#25454;&#24211;&#20013;&#20351;&#29992;&#30340;&#21629;&#20196;&#12290;</span>
startup             <span class="org-comment">-- &#22914;&#26524;&#19981;&#21152;&#21442;&#25968;&#65292;</span>
startup nomount     <span class="org-comment">-- &#21551;&#21160;&#21040; nomount &#38454;&#27573;</span>
startup mount       <span class="org-comment">-- &#21551;&#21160;&#21040; mount &#38454;&#27573;</span>

<span class="org-comment">-- &#24403;&#28982;&#65292;&#20063;&#21487;&#20197;&#36825;&#26679;&#20998;&#27493;&#21551;&#21160;&#65306;</span>
startup nomount
<span class="org-keyword">alter</span> database mount
<span class="org-keyword">alter</span> database <span class="org-keyword">open</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-3-2" class="outline-4">
<h4 id="sec-3-3-2"><span class="section-number-4">3.3.2</span> 数据库(Database)</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
<b>数据库</b>, 是保存在硬盘上的文件集合，它是数据的主要载体。
</p>
<pre class="example">
$OracleBase\oradata\[数据库名字]\
</pre>

<p>
可以从不同的角度去认识数据库，比如物理/逻辑角度：
</p>
</div>
<ol class="org-ol"><li><a id="sec-3-3-2-1" name="sec-3-3-2-1"></a>物理组件<br ><div class="outline-text-5" id="text-3-3-2-1">
<p>
数据库是保存在操作系统的一系列文件。
</p>

<p>
默认安装情况下，这些文件都在 <code>$ORACLE_BASE/oradata</code> 文件夹下：
</p>
<pre class="example">
oradata/
└── orcl [数据库的名字]
    ├── CONTROL01.CTL
    ├── CONTROL02.CTL
    ├── EXAMPLE01.DBF
    ├── REDO01.LOG
    ├── REDO02.LOG
    ├── REDO03.LOG
    ├── SYSAUX01.DBF
    ├── SYSTEM01.DBF
    ├── TEMP01.DBF
    ├── UNDOTBS01.DBF
    └── USERS01.DBF
</pre>

<p>
从文件角度分析，一个数据库包含下面几类（组件）：
</p>
<ol class="org-ol">
<li>控制文件(control file)。记录数据库的物理结构和其他信息，如数据库名称、各种文件位置等。多副本。
<pre class="example">
select * from v$controlfile;
</pre>
</li>
<li>数据文件(data file)。用来存储数据的文件，会自动扩张。数据以块为单位进行保存。
<pre class="example">
select name, status, enabled from v$datafile;
</pre>
</li>
<li>重做日志文件(redo log)。用来记录用户的所有操作，为了备份恢复。
一个数据库至少有两个日志组，每个日志组至少有一个成员，成员之间是镜像关系。
用户的操作会记录到 redo log 中，当一个组记录满了，会自动切换到下一个组。轮流循环。
<div class="org-src-container">

<pre class="src src-sql"><span class="org-comment">-- &#38656;&#35201;&#29702;&#35299; Oracle &#26085;&#24535;&#30340;&#24605;&#36335;:</span>
<span class="org-comment">-- &#23427;&#37319;&#21462;&#20102;&#12304;&#22810;&#20010;&#20998;&#32452;&#65292;&#36718;&#27969;&#24490;&#29615;&#20889;&#20837;&#65307;&#27599;&#32452;&#22810;&#25104;&#21592;&#65292;&#20114;&#20026;&#38236;&#20687;&#65307;&#20445;&#23384;&#26356;&#22810;&#20449;&#24687;&#65292;&#20351;&#29992;&#24402;&#26723;&#27169;&#24335;&#12305;&#30340;&#26041;&#24335;&#65292;&#20445;&#35777;&#20102;&#35760;&#24405;&#23433;&#20840;&#24615;&#12290;</span>
<span class="org-comment">-- &#22312;&#29983;&#20135;&#29615;&#22659;&#20013;&#65292;&#38656;&#35201;&#26085;&#24535;&#35843;&#25972;&#21040;&#19981;&#21516;&#30340;&#30913;&#30424;&#20013;&#65292;&#36825;&#26679;&#65292;&#21363;&#20351;&#26576;&#20010;&#25991;&#20214;&#25439;&#22351;&#65292;&#25110;&#26576;&#22359;&#30913;&#30424;&#25439;&#22351;&#65292;&#37117;&#21487;&#20197;&#36890;&#36807;&#38236;&#20687;&#30340;&#26085;&#24535;&#25991;&#20214;&#23545;&#25968;&#25454;&#36827;&#34892;&#24674;&#22797;&#12290;</span>

<span class="org-comment">-- &#26597;&#30475; redo log &#26085;&#24535;&#32452;</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> v$log;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> v$logfile;

<span class="org-comment">-- &#22686;&#21152;/&#21024;&#38500; &#26085;&#24535;&#32452;</span>
<span class="org-keyword">alter</span> database <span class="org-keyword">add</span>  logfile <span class="org-string">'d:/sss.rlog'</span> <span class="org-keyword">size</span> 100m;
<span class="org-keyword">alter</span> database <span class="org-keyword">drop</span> logfile <span class="org-string">'d:/sss.rlog'</span>;

<span class="org-comment">-- &#28165;&#31354;&#26085;&#24535;&#32452;</span>
<span class="org-keyword">alter</span> database clear logfile <span class="org-keyword">group</span> 1;
<span class="org-keyword">alter</span> database clear unarchived logfile <span class="org-keyword">group</span> 1;

<span class="org-comment">-- &#20026;&#26085;&#24535;&#32452; &#22686;&#21152;/&#21024;&#38500; &#25104;&#21592;</span>
<span class="org-keyword">alter</span> database <span class="org-keyword">add</span>  logfile member <span class="org-string">'d:/ssss.log'</span> <span class="org-keyword">to</span> <span class="org-keyword">group</span> 1;
<span class="org-keyword">alter</span> database <span class="org-keyword">drop</span> logfile member <span class="org-string">'d:/ssss.log'</span>;

<span class="org-comment">-- &#37325;&#21629;&#21517;&#25991;&#20214;</span>
<span class="org-comment">-- &#39318;&#20808;&#65292;&#22312;&#25991;&#20214;&#22841;&#31649;&#29702;&#22120;&#37324;&#65292;&#23558;&#25991;&#20214;&#25913;&#21517;&#65292;&#27604;&#22914;&#65292;&#25913;&#20026; ssss.redolog</span>
<span class="org-comment">-- &#20854;&#27425;&#65292;&#37325;&#21551;&#25968;&#25454;&#24211;&#21040; mount &#29366;&#24577;&#65292;&#28982;&#21518;&#25191;&#34892;&#37325;&#21629;&#21517;&#21629;&#20196;</span>
<span class="org-keyword">alter</span> database rename file <span class="org-string">'d:/ssss.log'</span> <span class="org-keyword">to</span> <span class="org-string">'d:/ssss.redolog'</span>;

<span class="org-comment">-- &#26085;&#24535;&#32452;&#19968;&#33324;&#26159;&#22312;&#20889;&#28385;&#30340;&#26102;&#20505;&#33258;&#21160;&#20999;&#25442;&#12290;</span>
<span class="org-comment">-- &#25105;&#20204;&#20063;&#21487;&#20197;&#25163;&#21160;&#20999;&#25442;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">system</span> switch logfile;
</pre>
</div>
</li>
<li>归档日志文件。是重做日志的补充（redo log 记录的记录是有限的），可以把写满的 redo log 进行备份。
<div class="org-src-container">

<pre class="src src-sql"><span class="org-comment">-- Oracle &#30340;&#24402;&#26723;&#27169;&#24335;&#40664;&#35748;&#26159;&#20851;&#38381;&#30340;</span>
<span class="org-comment">-- &#24402;&#26723;&#27169;&#24335;&#20250;&#21344;&#29992;&#22823;&#37327;&#31354;&#38388;</span>
<span class="org-comment">-- &#20294;&#20182;&#20204;&#29992;&#26356;&#22810;&#30340;&#31354;&#38388;&#65292;&#20445;&#23384;&#26356;&#22810;&#30340;&#21382;&#21490;&#35760;&#24405;&#65292;&#20445;&#38556;&#26356;&#22823;&#30340;&#23433;&#20840;&#24615;</span>

<span class="org-comment">-- &#26597;&#30475;&#29366;&#24577;</span>
archive log list;

<span class="org-comment">-- &#20999;&#25442;&#25968;&#25454;&#24211;&#21040;&#24402;&#26723;&#27169;&#24335;</span>
<span class="org-keyword">alter</span> database archivelog;

<span class="org-comment">-- &#21551;&#21160;</span>
archive log <span class="org-keyword">start</span>;

<span class="org-comment">-- &#26597;&#30475;&#29366;&#24577;</span>
archive log list;
</pre>
</div>
</li>
<li>其他文件
</li>
</ol>
</div>
</li>

<li><a id="sec-3-3-2-2" name="sec-3-3-2-2"></a>逻辑组件<br ><div class="outline-text-5" id="text-3-3-2-2">
<p>
<a href="https://docs.oracle.com/cd/B28359_01/server.111/b28318/physical.htm#CNCPT1082">https://docs.oracle.com/cd/B28359_01/server.111/b28318/physical.htm#CNCPT1082</a>
</p>

<p>
从 Oracle 内部管理数据的角度，可以将 Oracle 分为4个组件：
</p>
<ol class="org-ol">
<li>表空间(tablespace)
<ul class="org-ul">
<li>最基本的逻辑结构，是 Oracle 中进行数据恢复的最小单位，容纳着表、索引等对象
</li>
<li>数据库是由若干表空间组成的。一个表空间至少对应一个物理文件。
</li>
<li>实际开发中，不建议使用默认表空间。请为自己的业务创建自己的表空间。
</li>
</ul>
<div class="org-src-container">

<pre class="src src-sql"><span class="org-comment">-- &#20869;&#32622;&#30340;&#21508;&#31181;&#34920;&#31354;&#38388;</span>
<span class="org-comment">---- system/sysaux &#31995;&#32479;&#34920;&#31354;&#38388;/&#31995;&#32479;&#36741;&#21161;&#34920;&#31354;&#38388;&#65292;&#29992;&#26469;&#20445;&#23384;&#31995;&#32479;&#23383;&#20856;&#34920;&#21644;&#20854;&#20182;&#20449;&#24687;&#65292;&#25968;&#25454;&#24211;&#21019;&#24314;&#23436;&#20250;&#33258;&#21160;&#29983;&#25104;</span>
<span class="org-comment">---- users &#29992;&#25143;&#34920;&#31354;&#38388;&#65292;&#21019;&#24314;&#26032;&#29992;&#25143;&#26102;&#65292;&#40664;&#35748;&#20351;&#29992;&#30340;&#34920;&#31354;&#38388;</span>
<span class="org-comment">---- temp &#20020;&#26102;&#34920;&#31354;&#38388;</span>
<span class="org-comment">---- undo &#22238;&#28378;&#34920;&#31354;&#38388;</span>

<span class="org-comment">-- &#26597;&#30475;&#34920;&#31354;&#38388;&#20449;&#24687;</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> v$tablespace;

<span class="org-comment">-- &#26597;&#30475;&#25152;&#26377;&#34920;&#31354;&#38388;&#36319;&#25991;&#20214;&#23545;&#24212;&#20851;&#31995;</span>
<span class="org-keyword">SELECT</span>  FILE_NAME, BLOCKS, TABLESPACE_NAME <span class="org-keyword">from</span> dba_data_files;

<span class="org-comment">-- &#21019;&#24314;&#34920;&#31354;&#38388;</span>
<span class="org-keyword">create</span> tablespace xxx
  datafile   <span class="org-string">'D:/sss.dbf'</span>
  <span class="org-keyword">size</span>       50m
  autoextend <span class="org-keyword">on</span>
  <span class="org-keyword">next</span>       50m
  maxsize    1024m;

<span class="org-comment">-- &#21019;&#24314;&#20020;&#26102;&#34920;&#31354;&#38388;</span>
<span class="org-keyword">create</span> <span class="org-keyword">temporary</span> tablespace yyy
  tempfile <span class="org-string">'D:/ANOTHER_TMP.dbf'</span>;

<span class="org-comment">-- &#21024;&#38500;&#34920;&#31354;&#38388;</span>
<span class="org-keyword">drop</span> tablespace xxx;
</pre>
</div>
</li>
<li>段(Segment)
<ul class="org-ul">
<li>段是对象在数据库中占用的空间
</li>
<li>包括索引段、数据段等
</li>
<li>表空间被划分为若干区域，每个区域负责存放不同类型数据，这些区域这就是段
</li>
</ul>
</li>
<li>区(Extend)
<ul class="org-ul">
<li>由连续的数据块组成，由 Oracle 自动分配管理
</li>
<li>会自动扩展大小
</li>
</ul>
</li>
<li>块(Block)
<ul class="org-ul">
<li>数据块是 Oracle 数据库最小的逻辑单元
</li>
<li>它代表在读写操作的时候，每次处理的数据大小是多少
</li>
<li>正常情况下，它是操作系统块的整数倍，默认是 8 KB
</li>
<li>可以通过参数 db_block_size 控制
<pre class="example">
show parameters block;
</pre>
</li>
</ul>
</li>
</ol>


<figure>
<p><img src="assets/image/database-oracle/oracle_logic_2017-08-17_14-33-06.jpg" alt="oracle_logic_2017-08-17_14-33-06.jpg">
</p>
</figure>
</div>
</li></ol>
</div>
</div>
</section>

<section id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> 用户权限</h2>
</section>
<section id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> SQL 语句</h2>
</section>
<section id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Objects</h2>
</section>
<section id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> PL/SQL编程</h2>
</section>
<section id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> 锁/事务</h2>
</section>
<section id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> hint/explain</h2>
</section>
<section id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> Miscellaneous</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1"><span class="section-number-3">10.1</span> 操作系统历史 (Operate System History)</h3>
<div class="outline-text-3" id="text-10-1">

<figure>
<p><img src="assets/dot/os_history.jpg" alt="os_history.jpg">
</p>
</figure>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
<p class="author">Author: imfine</p>
<p class="date">Created: 2017-08-20 Sun 16:03</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.1.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation">Go ahead, never stop.</p>
</div>
</body>
</html>
