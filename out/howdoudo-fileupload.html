<!DOCTYPE html>
<html>
<head>
<title>文件上传</title>
<!-- 2017-07-13 Thu 18:56 -->
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="imfine">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="res/nnn.css">
<script src="res/iii.js">
/**
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "index.html");
org_html_manager.set("LINK_UP", "index.html");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "3");
org_html_manager.set("VIEW", "info");
**/
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="index.html"> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content">
<h1 class="title">文件上传</h1>
<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 前言</a></li>
<li><a href="#sec-2">2. 服务端</a></li>
<li><a href="#sec-3">3. 客户端</a></li>
</ul>
</div>
</nav>


<section id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 前言</h2>
<div class="outline-text-2" id="text-1">
<p>
如果要选择一个文件并上传到服务器, 你需要在 <code>&lt;form&gt;</code> 中添加 <code>&lt;input type=“file”&gt;</code> 字段.
根据 <a href="https://www.w3.org/TR/html4/interact/forms.html">HTML规范</a>, 你需要为 <code>form</code> 使用 <code>POST</code> 方法进行提交, 并需要将编码方式 <code>enctype</code> 设置为 <code>multipart/form-data</code>:
</p>

<div class="org-src-container">

<pre class="src src-html">&lt;<span style="color: #bc6ec5; font-weight: bold;">form</span> <span style="color: #7590db;">action</span>=<span style="color: #2d9574;">"upload"</span> <span style="color: #7590db;">method</span>=<span style="color: #2d9574;">"post"</span> <span style="color: #7590db;">enctype</span>=<span style="color: #2d9574;">"multipart/form-data"</span>&gt;
  &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"text"</span> <span style="color: #7590db;">name</span>=<span style="color: #2d9574;">"description"</span> <span style="color: #7590db;">placeholder</span>=<span style="color: #2d9574;">"&#25991;&#20214;&#25551;&#36848;"</span> /&gt;
  &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"file"</span> <span style="color: #7590db;">name</span>=<span style="color: #2d9574;">"file"</span> /&gt;
  &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"submit"</span> /&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">form</span>&gt;
</pre>
</div>

<p>
这样的表单提交的时候, 会在请求体(request body)中保存二进制的 <code>multipart</code> 数据, 这跟不设置 <code>enctype</code> 是完全不同的。
</p>


<p>
PS: <code>multipart</code> 编码的数据大致是这个样子的:
</p>
<pre>
------WebKitFormBoundaryrGKCBY7qhFd3TrwA
Content-Disposition: form-data; name="title"

harttle
------WebKitFormBoundaryrGKCBY7qhFd3TrwA
Content-Disposition: form-data; name="avatar"; filename="harttle.png"
Content-Type: image/png

 ... content of harttle.png ...
------WebKitFormBoundaryrGKCBY7qhFd3TrwA--
</pre>
</div>
</section>


<section id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> 服务端</h2>
<div class="outline-text-2" id="text-2">
<p>
在 Servlet 3.0 以前, Servlet API 本身不支持 <code>multipart/form-data</code>,
它只支持表单默认的 <code>application/x-www-form-urlencoded</code> 编码.
当提交 <code>multipart</code> 类型数据的时候, 在服务端, 调用 <code>HttpServletRequest#getParameter()</code> 会得到 <code>null</code> 值.
特别不方便.
</p>

<p>
这就是 <a href="http://commons.apache.org/fileupload">Apache Commons FileUpload</a> 出现的原因。
</p>


<p>
<b>1. 不要手动解析！</b>
</p>

<p>
理论上，你可以自己通过 <code>ServletRequest#getInputStream()</code> 手动解析数据,
但这是个细致并且繁琐的任务, 需要你对 HTML 规范有一定了解.
千万别浪费太多时间在这上面, 不仅没有意义, 而且你的解析可能包含很多错误.
最好的方式, 是选择一个成熟靠谱的实现.
</p>


<p>
<b>2. 如果你使用的是 Servlet 3.0 或以后的版本，使用内置的 MultiPart API ！！！</b>
</p>

<p>
如果你使用 Servlet 3.0 以上(Tomcat 7.0), 就可以使用标准 API 中提供的 <code>HttpServletRequest#getPart()</code> 获取文件数据.
同时, 可以使用 <code>getParameter()</code> 获取同一表单中其他的 <b>非文件</b> 字段的值。
</p>


<p>
要接收上传的数据, <b>总共分两步</b>:
</p>

<p>
【首先】 在你的 Servlet 上面标注 <code>@MultipartConfig</code>, 使你的 Servlet 有处理 <code>multipart/form-data</code> 的能力, 并使 <code>getPart()</code> 方法生效:
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #a45bad;">@WebServlet</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"/upload"</span><span style="color: #4f97d7;">)</span>
<span style="color: #a45bad;">@MultipartConfig</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">UploadServlet</span> <span style="color: #4f97d7; font-weight: bold;">extends</span> <span style="color: #ce537a; font-weight: bold;">HttpServlet</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">...</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
你也可以根据需要为 <code>@MultipartConfig</code> 增加参数, 这样可以配置上传的一些细节, 这些参数也可以放到 <code>web.xml</code> 中全局使用。
</p>

<p>
【然后】 你需要实现自己的 <code>doPost()</code> 方法:
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">doPost</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">HttpServletRequest</span> <span style="color: #7590db;">request</span>, <span style="color: #ce537a; font-weight: bold;">HttpServletResponse</span> <span style="color: #7590db;">response</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">ServletException</span>, <span style="color: #ce537a; font-weight: bold;">IOException</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#33719;&#21462; &lt;input type="text" name="description"&gt; &#30340;&#20540;</span>
    <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">description</span> = request.getParameter<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"description"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#33719;&#21462; &lt;input type="file" name="file"&gt; &#30340;&#20540;</span>
    <span style="color: #ce537a; font-weight: bold;">Part</span> <span style="color: #7590db;">part</span> = request.getPart<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"file"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#24120;&#29992;&#23646;&#24615;</span>
    System.out.printf<span style="color: #bc6ec5;">(</span>
                      <span style="color: #2d9574;">"Part &#23545;&#35937;&#23646;&#24615;&#26041;&#27861;&#65306;\n&gt; Name: %s\n&gt; Size: %d\n&gt; ContentType: %s\n&gt; getSubmittedFileName: %s\n&gt; HeaderNames: %s\n&gt; disposition: %s\n"</span>,
                      part.getName<span style="color: #2d9574;">()</span>,
                      part.getSize<span style="color: #2d9574;">()</span>,
                      part.getContentType<span style="color: #2d9574;">()</span>,
                      part.getSubmittedFileName<span style="color: #2d9574;">()</span>,
                      part.getHeaderNames<span style="color: #2d9574;">()</span>,
                      part.getHeader<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"content-disposition"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#24471;&#21040;&#25991;&#20214;&#21517;</span>
    <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">fileName</span> = part.getSubmittedFileName<span style="color: #bc6ec5;">()</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22788;&#29702;&#25991;&#20214;</span>
    part.write<span style="color: #bc6ec5;">(</span>&#20320;&#30340;&#20445;&#23384;&#36335;&#24452;<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20854;&#20182;&#25805;&#20316; ...</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
如果你在 form 表单中指定了 <b>multiple</b>: <code>&lt;input type=file multiple /&gt;</code>, 表示允许一次上传多个文件,
那么, 在服务端, 你可以使用 <code>HttpServletRequest#getParts()</code> 获取所有文件的列表, 然后根据需要逐个处理。
</p>

<p>
Servlet 3.1 新增了 <code>Part#getSubmittedFileName()</code> 方法, 它用来得到文件的原始名字,
如果是之前的版本, 文件的名字需要从 head 参数里手动获取, 比如:
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">fileName</span> = part.getHeader<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"content-disposition"</span><span style="color: #4f97d7;">)</span>.split<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"filename="</span><span style="color: #4f97d7;">)[</span>1<span style="color: #4f97d7;">]</span>.replace<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"\""</span>, <span style="color: #2d9574;">""</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>




<p>
<b>3. 如果你使用的是 Servlet 3.0 以前的版本, 请使用 Apache Commons FileUpload !</b>
</p>

<p>
这是当前最流行, 也是最成熟的第三方库, 你需要将两个 jar 包放到你的 lib 包下:
</p>
<ul class="org-ul">
<li>commons-fileupload.jar
</li>
<li>commons-io.jar
</li>
</ul>

<p>
它的使用也比较简单, 示例如下:
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">protected</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">doPost</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">HttpServletRequest</span> <span style="color: #7590db;">request</span>, <span style="color: #ce537a; font-weight: bold;">HttpServletResponse</span> <span style="color: #7590db;">response</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">ServletException</span>, <span style="color: #ce537a; font-weight: bold;">IOException</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">try</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#21021;&#22987;&#21270; uploader &#23545;&#35937;, &#38656;&#35201;&#19968;&#20010; FileItemFactory &#21442;&#25968;, &#29992;&#26469;&#37197;&#32622;&#23545;&#19978;&#20256;&#25991;&#20214;&#30340;&#38480;&#21046;</span>
        <span style="color: #ce537a; font-weight: bold;">ServletFileUpload</span> <span style="color: #7590db;">uploader</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ServletFileUpload</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">DiskFileItemFactory</span><span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;

        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35843;&#29992; parseRequest &#26041;&#27861;, &#23558; multipart &#25152;&#26377;&#30340;&#25968;&#25454;&#23553;&#35013;&#21040; list &#20013;</span>
        <span style="color: #ce537a; font-weight: bold;">List</span><span style="color: #2d9574;">&lt;</span><span style="color: #ce537a; font-weight: bold;">FileItem</span><span style="color: #2d9574;">&gt;</span> <span style="color: #7590db;">items</span> = uploader.parseRequest<span style="color: #2d9574;">(</span>request<span style="color: #2d9574;">)</span>;

        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#24490;&#29615;&#22788;&#29702;</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">FileItem</span> <span style="color: #7590db;">item</span> : items<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>item.isFormField<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22788;&#29702;&#26222;&#36890;&#23383;&#27573; (input type="text|radio|checkbox|etc", select, &#31561;).</span>
                <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">fieldName</span> = item.getFieldName<span style="color: #b1951d;">()</span>;
                <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">fieldValue</span> = item.getString<span style="color: #b1951d;">()</span>;
                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">... (&#20854;&#20182;&#25805;&#20316;)</span>
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22788;&#29702;&#25991;&#20214;&#25968;&#25454; (input type="file").</span>
                <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">fieldName</span> = item.getFieldName<span style="color: #b1951d;">()</span>;
                <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">fileName</span> = FilenameUtils.getName<span style="color: #b1951d;">(</span>item.getName<span style="color: #4f97d7;">()</span><span style="color: #b1951d;">)</span>;
                item.write<span style="color: #b1951d;">(</span>&#25105;&#30340;&#20445;&#23384;&#36335;&#24452;<span style="color: #b1951d;">)</span>;
                <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">... (&#20854;&#20182;&#25805;&#20316;)</span>
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">catch</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">FileUploadException</span> <span style="color: #7590db;">e</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">throw</span> <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ServletException</span><span style="color: #2d9574;">(</span><span style="color: #2d9574;">"&#35299;&#26512;&#25991;&#20214;&#20986;&#38169;."</span>, e<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">...</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
就这么简单。
</p>
</div>
</section>

<section id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> 客户端</h2>
<div class="outline-text-2" id="text-3">
<p>
不管在 IE/Firefox 还是 Chrome 浏览器上, 上传按钮的样式都很丑, 所以, 我们需要:
</p>

<p>
<b>1. 自定义上传按钮的样式!</b>
</p>

<p>
怎么搞呢? 一般的手段是: 通过 css 将上传按钮变透明(opacity), 并放到其他元素上面(position).
</p>

<p>
在 html5 中，也可以使用 label 配合 input 的 <code>display:none</code> 实现：
</p>
<div class="org-src-container">

<pre class="src src-html">&lt;<span style="color: #bc6ec5; font-weight: bold;">label</span> <span style="color: #7590db;">style</span>=<span style="color: #2d9574;">"&#25105;&#30340;&#26679;&#24335;"</span>&gt;
  &#36873;&#25321;&#22270;&#29255;
  &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"file"</span> <span style="color: #7590db;">style</span>=<span style="color: #2d9574;">"display:none"</span> /&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">label</span>&gt;
</pre>
</div>


<p>
除了样式要好看, 另外一个重要的用户体验是:
</p>

<p>
<b>2. 选择文件后给我一个预览图吧！</b>:
</p>

<blockquote>
<p>
在图片上传中, 如果选中后, 能够预览图片, 那是极好的啊！  &#x2013; by 牛顿
</p>
</blockquote>

<p>
可怎么实现呢? 方法很多, 但这样是不行的:
</p>
<pre class="example">
$('#preview').attrib('src', $(':file').val())
</pre>

<p>
获取到的 file 字段的值是类似 <code>C:\FakePath\xxxx</code> 的形式, 因为浏览器为了安全方面的考虑, 并不会允许 js 能获取到真正的文件路径.
</p>

<p>
怎么办呢? 使用 html5 的 <code>URL#createObjectURL()</code> 是一种选择, 也可以使用 <code>FileReader</code> 进行更复杂的处理.
</p>


<p>
<b>3. 下面是一个样式+预览的示例:</b>
</p>

<div class="org-src-container">

<pre class="src src-html">&lt;<span style="color: #bc6ec5; font-weight: bold;">body</span>&gt;
  <span style="color: #2aa1ae; background-color: #292e34;">&lt;!-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#35774;&#32622;&#26679;&#24335; </span><span style="color: #2aa1ae; background-color: #292e34;">--&gt;</span>
  &lt;<span style="color: #bc6ec5; font-weight: bold;">style</span>&gt;
    .filewrapper {
        padding: 8px 12px;
        font-size: 1.2em;
        background: #333;
        color: goldenrod;
        border-radius: 5px;
        cursor: hand;
    }
    .filewrapper:hover {
        background: #000;
    }
  &lt;/<span style="color: #bc6ec5; font-weight: bold;">style</span>&gt;

  <span style="color: #2aa1ae; background-color: #292e34;">&lt;!-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#23558; input &#38544;&#34255;&#65292;&#32473; label &#19968;&#20010;&#32654;&#20029;&#30340;&#22806;&#35266;&#12290;&#28857;&#20987; label &#30340;&#26102;&#20505;&#65292;&#20250;&#28608;&#27963;&#30456;&#23545;&#24212;&#30340; input </span><span style="color: #2aa1ae; background-color: #292e34;">--&gt;</span>
  &lt;<span style="color: #bc6ec5; font-weight: bold;">label</span> <span style="color: #7590db;">class</span>=<span style="color: #2d9574;">"filewrapper"</span>&gt;
    &#28857;&#20987;&#36873;&#25321;&#22270;&#29255;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">input</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"b"</span> <span style="color: #7590db;">name</span>=<span style="color: #2d9574;">"b"</span> <span style="color: #7590db;">style</span>=<span style="color: #2d9574;">"display:none"</span> <span style="color: #7590db;">type</span>=<span style="color: #2d9574;">"file"</span> /&gt;
  &lt;/<span style="color: #bc6ec5; font-weight: bold;">label</span>&gt;

  <span style="color: #2aa1ae; background-color: #292e34;">&lt;!-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#36873;&#25321;&#22270;&#29255;&#21518;&#30340;&#39044;&#35272;&#22270; </span><span style="color: #2aa1ae; background-color: #292e34;">--&gt;</span>
  &lt;<span style="color: #bc6ec5; font-weight: bold;">div</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">img</span> <span style="color: #7590db;">id</span>=<span style="color: #2d9574;">"preview"</span> <span style="color: #7590db;">src</span>=<span style="color: #2d9574;">""</span> <span style="color: #7590db;">style</span>=<span style="color: #2d9574;">"width: 200px; height: 200px; margin: 20px auto;"</span>&gt;
  &lt;/<span style="color: #bc6ec5; font-weight: bold;">div</span>&gt;

  <span style="color: #2aa1ae; background-color: #292e34;">&lt;!-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#36873;&#25321;&#25991;&#20214;&#21518;, &#22312; preview &#21306;&#22495;&#26174;&#31034;&#22270;&#29255;&#39044;&#35272; </span><span style="color: #2aa1ae; background-color: #292e34;">--&gt;</span>
  <span style="color: #2aa1ae; background-color: #292e34;">&lt;!-- </span><span style="color: #2aa1ae; background-color: #292e34;">&#20351;&#29992;&#20102; html5 &#30340; FileReader &#23545;&#35937; </span><span style="color: #2aa1ae; background-color: #292e34;">--&gt;</span>
  &lt;<span style="color: #bc6ec5; font-weight: bold;">script</span>&gt;
    $(<span style="color: #2d9574;">"#b"</span>).change(function (event) {
        var file = $(<span style="color: #2d9574;">"#b"</span>)[0].files[0];
        var reader = new FileReader();
        reader.onload = function (e) {
            $(<span style="color: #2d9574;">"#preview"</span>).attr(<span style="color: #2d9574;">"src"</span>, this.result);
        };
        reader.readAsDataURL(file);
    });
  &lt;/<span style="color: #bc6ec5; font-weight: bold;">script</span>&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">body</span>&gt;
</pre>
</div>

<p>
效果图为:
</p>


<figure>
<p><img src="res/images/howdoudo-fileupload/5233708_2017-07-06_00-21-36_2017-07-10_13-40-26.png" alt="5233708_2017-07-06_00-21-36_2017-07-10_13-40-26.png">
</p>
</figure>



<p>
<b>4. 另一个重点, 是实现异步上传:</b>
</p>

<p>
话不多说，代码在此:
</p>
<div class="org-src-container">

<pre class="src src-js"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#34920;&#21333;&#25552;&#20132;&#65292;&#20132;&#32473; submitForm &#20989;&#25968;&#22788;&#29702;</span>
$<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'form'</span><span style="color: #4f97d7;">)</span>.on<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'submit'</span>, submitForm<span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#36890;&#36807; jQuery &#36827;&#34892;&#24322;&#27493;&#25552;&#20132;</span>
<span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">submitForm</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#20351;&#29992; html5 &#30340; FormData &#23553;&#35013;&#34920;&#21333;&#25968;&#25454;</span>
    <span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #7590db;">formData</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">FormData</span><span style="color: #bc6ec5;">(</span>$<span style="color: #2d9574;">(</span><span style="color: #2d9574;">'form'</span><span style="color: #2d9574;">)[</span>0<span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;

    $.ajax<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">{</span>
        url : <span style="color: #2d9574;">'/upload'</span>,
        method : <span style="color: #2d9574;">'POST'</span>,
        data : formData,
        cache : <span style="color: #a45bad;">false</span>,
        processData : <span style="color: #a45bad;">false</span>,   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">jQuery &#21834;&#65292;&#20320;&#19981;&#35201;&#20462;&#25913;&#25105;&#19978;&#20256;&#30340;&#25968;&#25454;</span>
        contentType : <span style="color: #a45bad;">false</span>,   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">jQuery &#21834;&#65292;&#20320;&#19981;&#35201;&#31169;&#33258;&#35774;&#32622; Content-Type</span>
        <span style="color: #bc6ec5; font-weight: bold;">xhr</span>: <span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #67b11d;">()</span> <span style="color: #67b11d;">{</span>     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22914;&#26524;&#38656;&#35201;&#36827;&#24230;&#26465;&#30340;&#35805;&#65292;&#21487;&#20197;&#20026; xhr &#23545;&#35937;&#30340; upload &#32465;&#23450; progress &#20107;&#20214;&#65307;&#22914;&#26524;&#19981;&#38656;&#35201;&#36827;&#24230;&#26465;&#65292;&#36825;&#37324;&#21487;&#30465;&#30053;</span>
            <span style="color: #4f97d7; font-weight: bold;">let</span> <span style="color: #7590db;">xhr</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">window.XMLHttpRequest</span><span style="color: #b1951d;">()</span>;
            xhr.upload.addEventListener<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"progress"</span>, processHandler, <span style="color: #a45bad;">false</span><span style="color: #b1951d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> xhr;
        <span style="color: #67b11d;">}</span>

    <span style="color: #2d9574;">}</span><span style="color: #bc6ec5;">)</span>.done<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">function</span><span style="color: #2d9574;">(</span><span style="color: #7590db;">data</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
        console.log<span style="color: #67b11d;">(</span>data<span style="color: #67b11d;">)</span>;
        alert<span style="color: #67b11d;">(</span>data<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">false</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#36827;&#24230;&#30417;&#21548;&#20989;&#25968;&#65292;&#21487;&#20197;&#33258;&#23450;&#20041;&#36827;&#24230;&#26465;&#21464;&#21270;&#31561;&#25928;&#26524;</span>
<span style="color: #4f97d7; font-weight: bold;">function</span> <span style="color: #bc6ec5; font-weight: bold;">processHandler</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">event</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>event.lengthComputable<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#33719;&#21462;&#36827;&#24230;</span>
        <span style="color: #4f97d7; font-weight: bold;">var</span> <span style="color: #7590db;">percent</span> = parseInt<span style="color: #2d9574;">(</span>100 * event.loaded / event.total<span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#26681;&#25454;&#36827;&#24230;&#26356;&#26032;&#26174;&#31034;</span>
        console.log<span style="color: #2d9574;">(</span>percent<span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#23436;&#25104;&#20043;&#21518;...</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>percent === 100<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>


<p>
<b>z. 最后, 我们可以选择一些上传插件, 为项目快速增加上传功能.</b>
</p>
<ul class="org-ul">
<li><a href="https://github.com/blueimp/jQuery-File-Upload">jQuery-File-Upload</a>
</li>
<li><a href="http://www.dropzonejs.com/">Dropzone JS</a>
</li>
<li>其他
</li>
</ul>
</div>
</section>
</div>
<div id="postamble" class="status">
<p class="author">Author: imfine</p>
<p class="date">Created: 2017-07-13 Thu 18:56</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.1.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation">Go ahead, never stop.</p>
</div>
</body>
</html>
